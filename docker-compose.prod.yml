# ============================================
# LEEMASMART BACKEND - PRODUCTION DOCKER COMPOSE
# ============================================
# Production overrides with Traefik labels for SSL/TLS
#
# PREREQUISITES:
#   1. Deploy global Traefik first (see traefik/ folder)
#   2. Create network: docker network create proxy-network
#
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # ==========================================
  # Saleor - Production Configuration
  # ==========================================
  saleor:
    container_name: leemasmart-saleor-prod
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy-network"
      # Main API router
      - "traefik.http.routers.saleor.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.saleor.entrypoints=websecure"
      - "traefik.http.routers.saleor.tls.certresolver=letsencrypt"
      - "traefik.http.services.saleor.loadbalancer.server.port=8000"

      # CORS Middleware - Allow frontend to send saleor-channel header
      - "traefik.http.middlewares.saleor-cors.headers.accesscontrolallowmethods=GET,POST,OPTIONS"
      - "traefik.http.middlewares.saleor-cors.headers.accesscontrolallowheaders=Content-Type,Authorization,saleor-channel,saleor-event-type"
      - "traefik.http.middlewares.saleor-cors.headers.accesscontrolalloworiginlist=http://localhost:3000,https://leemasmart.com,https://www.leemasmart.com"
      - "traefik.http.middlewares.saleor-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.saleor-cors.headers.addvaryheader=true"

      # Headers middleware (forwarded proto)
      - "traefik.http.middlewares.saleor-headers.headers.customrequestheaders.X-Forwarded-Proto=https"

      # Apply both middlewares
      - "traefik.http.routers.saleor.middlewares=saleor-cors,saleor-headers"
    environment:
      DEBUG: "false"
      ENABLE_SSL: "false"
    command: >
      sh -c "
        python manage.py migrate &&
        python manage.py collectstatic --noinput &&
        uvicorn saleor.asgi:application --host 0.0.0.0 --port 8000 --workers 4 --lifespan off --ws none
      "
    ports:
      - "8000:8000"
    networks:
      - leemasmart-network
      - proxy-network
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # ==========================================
  # Saleor Worker - Production Configuration
  # ==========================================
  saleor-worker:
    container_name: leemasmart-saleor-worker-prod
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # ==========================================
  # Saleor Beat - Production Configuration
  # ==========================================
  saleor-beat:
    container_name: leemasmart-saleor-beat-prod
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ==========================================
  # Dashboard - Production Configuration
  # ==========================================
  dashboard:
    container_name: leemasmart-dashboard-prod
    build:
      args:
        API_URL: ${API_URL:-https://saleor.leemasmart.com/graphql/}
        APP_MOUNT_URI: /dashboard/
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy-network"
      # Dashboard router with path prefix
      - "traefik.http.routers.dashboard.rule=Host(`${DOMAIN}`) && PathPrefix(`/dashboard`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.services.dashboard.loadbalancer.server.port=80"
    ports:
      - "9000:80"
    networks:
      - leemasmart-network
      - proxy-network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ==========================================
  # PostgreSQL - Production Configuration
  # ==========================================
  postgres:
    container_name: leemasmart-postgres-prod
    # Don't expose port in production
    ports: []
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # ==========================================
  # Redis - Production Configuration
  # ==========================================
  redis:
    container_name: leemasmart-redis-prod
    # Don't expose port in production
    ports: []
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ==========================================
  # Gateway - Landing Page & Reverse Proxy
  # ==========================================
  gateway:
    image: nginx:alpine
    container_name: leemasmart-gateway
    restart: unless-stopped
    depends_on:
      - saleor
      - dashboard
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy-network"
      # Landing page router
      - "traefik.http.routers.gateway.rule=Host(`${DOMAIN:-saleor.leemasmart.com}`)"
      - "traefik.http.routers.gateway.entrypoints=websecure"
      - "traefik.http.routers.gateway.tls.certresolver=letsencrypt"
      - "traefik.http.services.gateway.loadbalancer.server.port=80"
      # HTTP router (for Let's Encrypt challenge)
      - "traefik.http.routers.gateway-http.rule=Host(`${DOMAIN:-saleor.leemasmart.com}`)"
      - "traefik.http.routers.gateway-http.entrypoints=web"
    volumes:
      - ./docker/nginx/gateway.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/nginx/landing/index.html:/usr/share/nginx/html/index.html:ro
    ports:
      - "8080:80"
    networks:
      - leemasmart-network
      - proxy-network

# ==========================================
# Production Volumes
# ==========================================
volumes:
  shiprocket-data:
